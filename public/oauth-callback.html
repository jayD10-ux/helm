<!DOCTYPE html>
<html>
<head>
    <title>OAuth Callback</title>
</head>
<body>
    <script>
        console.log('OAuth callback page loaded');
        
        // Get the code from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        const error_description = urlParams.get('error_description');
        
        console.log('URL parameters:', {
            code: code ? 'present' : 'missing',
            error,
            error_description
        });

        if (error) {
            console.error('GitHub OAuth error:', error, error_description);
            const errorMessage = error_description || error;
            console.log('Redirecting to error page with message:', errorMessage);
            window.location.href = `/?error=${encodeURIComponent(errorMessage)}`;
        } else if (code) {
            // Get the return URL from localStorage
            const returnUrl = localStorage.getItem('githubOAuthReturnTo') || '/';
            console.log('Return URL:', returnUrl);
            
            // Remove the stored return URL
            localStorage.removeItem('githubOAuthReturnTo');
            
            // Redirect back to the app with the code
            console.log('Redirecting back to app with code');
            const separator = returnUrl.includes('?') ? '&' : '?';
            const redirectUrl = `${returnUrl}${separator}github_code=${code}`;
            console.log('Final redirect URL:', redirectUrl);
            window.location.href = redirectUrl;
        } else {
            console.error('No code or error received from GitHub');
            window.location.href = '/?error=No+authorization+code+received';
        }
    </script>
</body>
</html>